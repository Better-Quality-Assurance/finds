generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH.JS MODELS
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// USER MODELS
// ============================================================================

enum Role {
  USER
  SELLER
  MODERATOR
  REVIEWER
  ADMIN
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     DateTime? @map("email_verified")
  name              String?
  phone             String?
  phoneVerified     DateTime? @map("phone_verified")
  phoneVerifyCode   String?   @map("phone_verify_code")
  phoneVerifyExpiry DateTime? @map("phone_verify_expiry")
  image             String?
  passwordHash      String?   @map("password_hash")
  role              Role      @default(USER)
  country           String? // ISO country code for anonymous bidder display

  // Bidding eligibility
  biddingEnabled   Boolean @default(false)
  stripeCustomerId String? @map("stripe_customer_id")

  // Stripe Connect (for sellers)
  stripeConnectAccountId   String?   @map("stripe_connect_account_id")
  stripeConnectStatus      String?   @map("stripe_connect_status") // 'pending', 'active', 'restricted'
  payoutEnabled            Boolean   @default(false) @map("payout_enabled")
  stripeConnectOnboardedAt DateTime? @map("stripe_connect_onboarded_at")

  // Ban tracking
  bannedAt    DateTime? @map("banned_at")
  banReason   String?   @map("ban_reason") @db.Text
  unbannedAt  DateTime? @map("unbanned_at")
  unbanReason String?   @map("unban_reason") @db.Text

  // Seller ratings
  averageRating Float? @map("average_rating")
  totalReviews  Int    @default(0) @map("total_reviews")
  followerCount Int    @default(0) @map("follower_count")

  // GDPR & Preferences
  marketingConsent     Boolean   @default(false)
  marketingConsentDate DateTime? @map("marketing_consent_date")
  preferredLanguage    String    @default("en") @map("preferred_language")
  preferredCurrency    String    @default("EUR") @map("preferred_currency")
  termsAcceptedAt      DateTime? @map("terms_accepted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts       Account[]
  sessions       Session[]
  listings       Listing[]
  bids           Bid[]
  watchlist      Watchlist[]
  bidDeposits    BidDeposit[]
  comments       Comment[]
  auditLogs      AuditLog[]      @relation("AuditActor")
  fraudAlerts    FraudAlert[]
  dataRequests   DataRequest[]
  consentRecords ConsentRecord[]
  sellerReviews  SellerReview[]  @relation("SellerReviews")
  reviewsGiven   SellerReview[]  @relation("ReviewsGiven")
  following      SellerFollow[]  @relation("Following")
  followers      SellerFollow[]  @relation("Followers")

  @@map("users")

  // Messaging relations
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  messages            Message[]
}

// ============================================================================
// LISTING MODELS
// ============================================================================

enum VehicleCategory {
  CLASSIC_CAR
  RETRO_CAR
  BARN_FIND
  PROJECT_CAR
  MOTORCYCLE
  PARTS
  MEMORABILIA
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  CHANGES_REQUESTED
  APPROVED
  REJECTED
  ACTIVE
  SOLD
  WITHDRAWN
  EXPIRED
}

model Listing {
  id       String @id @default(cuid())
  sellerId String @map("seller_id")
  seller   User   @relation(fields: [sellerId], references: [id])

  // Vehicle Info
  title               String
  description         String          @db.Text
  category            VehicleCategory
  make                String
  model               String
  year                Int
  mileage             Int?
  mileageUnit         String          @default("km") @map("mileage_unit")
  vin                 String?
  registrationCountry String?         @map("registration_country")

  // Condition
  conditionRating Int?    @map("condition_rating")
  conditionNotes  String? @map("condition_notes") @db.Text
  knownIssues     String? @map("known_issues") @db.Text
  isRunning       Boolean @default(true) @map("is_running")

  // Detailed Condition Grid (Catawiki-style 5 categories)
  conditionOverall          String? @map("condition_overall") // Excellent, Very Good, Good, Fair, Poor
  conditionOverallNotes     String? @map("condition_overall_notes") @db.Text
  conditionPaintBody        String? @map("condition_paint_body")
  conditionPaintBodyNotes   String? @map("condition_paint_body_notes") @db.Text
  conditionInterior         String? @map("condition_interior")
  conditionInteriorNotes    String? @map("condition_interior_notes") @db.Text
  conditionFrame            String? @map("condition_frame")
  conditionFrameNotes       String? @map("condition_frame_notes") @db.Text
  conditionMechanical       String? @map("condition_mechanical")
  conditionMechanicalNotes  String? @map("condition_mechanical_notes") @db.Text

  // Location
  locationCountry String  @default("RO") @map("location_country")
  locationCity    String  @map("location_city")
  locationRegion  String? @map("location_region")

  // Pricing
  startingPrice Decimal  @map("starting_price") @db.Decimal(12, 2)
  reservePrice  Decimal? @map("reserve_price") @db.Decimal(12, 2)
  estimateLow   Int?     @map("estimate_low") // Estimated value range (low)
  estimateHigh  Int?     @map("estimate_high") // Estimated value range (high)
  currency      String   @default("EUR")

  // Status & Review
  status          ListingStatus @default(DRAFT)
  reviewedById    String?       @map("reviewed_by_id")
  reviewedAt      DateTime?     @map("reviewed_at")
  rejectionReason String?       @map("rejection_reason") @db.Text
  changeRequests  Json          @default("[]") @map("change_requests")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  submittedAt DateTime? @map("submitted_at")
  approvedAt  DateTime? @map("approved_at")

  // Full-text search (managed by PostgreSQL trigger)
  searchVector Unsupported("tsvector")? @map("search_vector")

  // Relations
  media          ListingMedia[]
  auction        Auction?
  comments       Comment[]
  aiAnalysis     AIListingAnalysis?
  aiCarReview    AICarReview?
  aiImprovements AIListingImprovement[]
  conversations  Conversation[]

  @@index([status])
  @@index([sellerId])
  @@index([category])
  @@index([status, createdAt(sort: Desc)])
  @@map("listings")
}

enum MediaType {
  PHOTO
  VIDEO
}

model ListingMedia {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  type         MediaType
  storagePath  String    @map("storage_path")
  publicUrl    String    @map("public_url")
  thumbnailUrl String?   @map("thumbnail_url")
  originalUrl  String?   @map("original_url") // Original unprocessed URL (admin-only if plate blurred)

  position  Int
  isPrimary Boolean @default(false) @map("is_primary")
  category  String? // exterior, interior, engine, documentation, etc.
  caption   String?

  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")
  width    Int?
  height   Int?

  // License plate detection
  licensePlateDetected Boolean @default(false) @map("license_plate_detected")
  licensePlateBlurred  Boolean @default(false) @map("license_plate_blurred")
  plateDetectionData   Json?   @map("plate_detection_data") // Bounding boxes, confidence
  needsManualReview    Boolean @default(false) @map("needs_manual_review") // Flagged when blur fails after retries

  createdAt DateTime @default(now()) @map("created_at")

  @@index([listingId])
  @@map("listing_media")
}

// ============================================================================
// AUCTION MODELS
// ============================================================================

enum AuctionStatus {
  SCHEDULED
  ACTIVE
  EXTENDED
  ENDED
  SOLD
  NO_SALE
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Auction {
  id        String  @id @default(cuid())
  listingId String  @unique @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id])

  // Timing
  startTime       DateTime @map("start_time")
  originalEndTime DateTime @map("original_end_time")
  currentEndTime  DateTime @map("current_end_time")

  // Anti-sniping
  antiSnipingEnabled          Boolean @default(true) @map("anti_sniping_enabled")
  antiSnipingWindowMinutes    Int     @default(2) @map("anti_sniping_window_minutes")
  antiSnipingExtensionMinutes Int     @default(2) @map("anti_sniping_extension_minutes")
  extensionCount              Int     @default(0) @map("extension_count")
  maxExtensions               Int     @default(10) @map("max_extensions")

  // Pricing
  startingPrice Decimal  @map("starting_price") @db.Decimal(12, 2)
  reservePrice  Decimal? @map("reserve_price") @db.Decimal(12, 2)
  reserveMet    Boolean  @default(false) @map("reserve_met")
  currentBid    Decimal? @map("current_bid") @db.Decimal(12, 2)
  bidIncrement  Decimal  @default(100) @map("bid_increment") @db.Decimal(12, 2)
  currency      String   @default("EUR")

  // Bid tracking
  bidCount         Int @default(0) @map("bid_count")
  nextBidderNumber Int @default(1) @map("next_bidder_number") // Counter for anonymous bidder numbers

  // Status
  status AuctionStatus @default(SCHEDULED)

  // Winner
  winnerId     String?  @map("winner_id")
  winningBidId String?  @map("winning_bid_id")
  finalPrice   Decimal? @map("final_price") @db.Decimal(12, 2)

  // Fees
  buyerFeeRate   Decimal  @default(0.05) @map("buyer_fee_rate") @db.Decimal(4, 3)
  buyerFeeAmount Decimal? @map("buyer_fee_amount") @db.Decimal(12, 2)

  // Payment tracking (buyer)
  paymentStatus   PaymentStatus @default(UNPAID) @map("payment_status")
  paymentIntentId String?       @map("payment_intent_id")
  paidAt          DateTime?     @map("paid_at")
  paymentDeadline DateTime?     @map("payment_deadline")

  // Seller payout tracking
  sellerPayoutStatus String?   @map("seller_payout_status") // 'pending', 'processing', 'completed', 'failed'
  sellerPayoutId     String?   @map("seller_payout_id") // Stripe transfer ID
  sellerPayoutAmount Decimal?  @map("seller_payout_amount") @db.Decimal(12, 2)
  sellerPaidAt       DateTime? @map("seller_paid_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bids          Bid[]
  watchlist     Watchlist[]
  sellerReviews SellerReview[]

  @@index([status])
  @@index([currentEndTime])
  @@map("auctions")
}

model Bid {
  id        String  @id @default(cuid())
  auctionId String  @map("auction_id")
  auction   Auction @relation(fields: [auctionId], references: [id])
  bidderId  String  @map("bidder_id")
  bidder    User    @relation(fields: [bidderId], references: [id])

  bidderNumber  Int     @default(0) @map("bidder_number") // Anonymous bidder number (1, 2, 3...) within this auction
  bidderCountry String? @map("bidder_country") // Country code for display

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  isWinning         Boolean @default(false) @map("is_winning")
  isValid           Boolean @default(true) @map("is_valid")
  invalidatedReason String? @map("invalidated_reason")

  triggeredExtension Boolean @default(false) @map("triggered_extension")

  depositHoldId String? @map("deposit_hold_id")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([auctionId])
  @@index([bidderId])
  @@index([createdAt(sort: Desc)])
  @@index([auctionId, isValid, createdAt(sort: Desc)])
  @@map("bids")
}

// ============================================================================
// PAYMENT MODELS
// ============================================================================

enum DepositStatus {
  PENDING
  HELD
  CAPTURED
  RELEASED
  FAILED
}

model BidDeposit {
  id        String  @id @default(cuid())
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id])
  auctionId String? @map("auction_id")

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  stripePaymentIntentId String  @map("stripe_payment_intent_id")
  stripePaymentMethodId String? @map("stripe_payment_method_id")

  status DepositStatus @default(PENDING)

  heldAt     DateTime? @map("held_at")
  releasedAt DateTime? @map("released_at")
  capturedAt DateTime? @map("captured_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([auctionId])
  @@index([status])
  @@index([userId, status, createdAt])
  @@map("bid_deposits")
}

// ============================================================================
// ENGAGEMENT MODELS
// ============================================================================

model Watchlist {
  id        String  @id @default(cuid())
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId String  @map("auction_id")
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  notifyOnBid Boolean @default(true) @map("notify_on_bid")
  notifyOnEnd Boolean @default(true) @map("notify_on_end")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, auctionId])
  @@index([userId])
  @@index([auctionId])
  @@index([auctionId, notifyOnBid])
  @@index([auctionId, notifyOnEnd])
  @@index([userId, createdAt(sort: Desc)])
  @@map("watchlist")
}

model Comment {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  authorId  String  @map("author_id")
  author    User    @relation(fields: [authorId], references: [id])
  parentId  String? @map("parent_id")

  content  String  @db.Text
  isHidden Boolean @default(false) @map("is_hidden")
  isPinned Boolean @default(false) @map("is_pinned")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // AI Moderation
  aiModeration AICommentModeration?

  @@index([listingId])
  @@index([authorId])
  @@map("comments")
}

model SellerFollow {
  id         String   @id @default(cuid())
  followerId String   @map("follower_id")
  follower   User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  sellerId   String   @map("seller_id")
  seller     User     @relation("Followers", fields: [sellerId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([followerId, sellerId])
  @@index([sellerId])
  @@index([followerId])
  @@map("seller_follows")
}

// ============================================================================
// FRAUD & AUDIT MODELS
// ============================================================================

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  FALSE_POSITIVE
}

model FraudAlert {
  id        String  @id @default(cuid())
  userId    String? @map("user_id")
  user      User?   @relation(fields: [userId], references: [id])
  auctionId String? @map("auction_id")
  bidId     String? @map("bid_id")

  alertType String        @map("alert_type")
  severity  AlertSeverity
  details   Json

  status          AlertStatus @default(OPEN)
  reviewedById    String?     @map("reviewed_by_id")
  reviewedAt      DateTime?   @map("reviewed_at")
  resolutionNotes String?     @map("resolution_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([severity])
  @@map("fraud_alerts")
}

enum AuditSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AuditStatus {
  SUCCESS
  FAILURE
  BLOCKED
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  actorId        String? @map("actor_id")
  actor          User?   @relation("AuditActor", fields: [actorId], references: [id])
  actorEmail     String? @map("actor_email")
  actorIp        String? @map("actor_ip")
  actorUserAgent String? @map("actor_user_agent") @db.Text

  action       String
  resourceType String  @map("resource_type")
  resourceId   String? @map("resource_id")

  severity AuditSeverity?
  status   AuditStatus?

  details      Json    @default("{}")
  changes      Json?
  errorMessage String? @map("error_message") @db.Text

  sessionId    String? @map("session_id")
  requestId    String? @map("request_id")
  functionName String? @map("function_name")

  @@index([createdAt(sort: Desc)])
  @@index([actorId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([severity])
  @@index([action, createdAt(sort: Desc)])
  @@map("audit_log")
}

// ============================================================================
// GDPR MODELS
// ============================================================================

enum ConsentType {
  ESSENTIAL
  ANALYTICS
  MARKETING
  DATA_PROCESSING
}

model ConsentRecord {
  id     String  @id @default(cuid())
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  consentType ConsentType @map("consent_type")
  granted     Boolean

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([ipAddress])
  @@map("consent_records")
}

enum DataRequestType {
  EXPORT
  DELETE
  RECTIFY
}

enum DataRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

model DataRequest {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  requestType DataRequestType   @map("request_type")
  status      DataRequestStatus @default(PENDING)

  exportFilePath  String?   @map("export_file_path")
  exportExpiresAt DateTime? @map("export_expires_at")

  processedById   String?   @map("processed_by_id")
  processedAt     DateTime? @map("processed_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@map("data_requests")
}

// ============================================================================
// AI MODERATION MODELS
// ============================================================================

enum AIAnalysisType {
  LISTING_APPROVAL
  COMMENT_MODERATION
  BID_PATTERN
  CAR_REVIEW
}

enum AIAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ModerationDecision {
  APPROVE
  REJECT
  FLAG_FOR_REVIEW
  NEEDS_CHANGES
}

model AIListingAnalysis {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Analysis status
  status AIAnalysisStatus @default(PENDING)

  // Approval recommendation
  decision          ModerationDecision?
  confidenceScore   Float?              @map("confidence_score")
  approvalReasoning String?             @map("approval_reasoning") @db.Text

  // Content analysis
  titleAnalysis       Json? @map("title_analysis") // Spam detection, quality
  descriptionAnalysis Json? @map("description_analysis") // Completeness, red flags
  imageAnalysis       Json? @map("image_analysis") // Quality, authenticity, issues

  // Detected issues
  issues      Json @default("[]") // Array of {type, severity, description}
  suggestions Json @default("[]") // Array of suggested improvements

  // Processing metadata
  modelUsed        String? @map("model_used")
  tokensUsed       Int?    @map("tokens_used")
  processingTimeMs Int?    @map("processing_time_ms")
  errorMessage     String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([listingId])
  @@index([status])
  @@index([decision])
  @@map("ai_listing_analysis")
}

model AICarReview {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Analysis status
  status AIAnalysisStatus @default(PENDING)

  // Vehicle assessment
  overallScore     Int? // 1-100
  conditionSummary String? @map("condition_summary") @db.Text
  highlights       Json    @default("[]") // Positive aspects
  concerns         Json    @default("[]") // Potential issues

  // Market value estimation
  estimatedValueLow  Decimal? @map("estimated_value_low") @db.Decimal(12, 2)
  estimatedValueHigh Decimal? @map("estimated_value_high") @db.Decimal(12, 2)
  estimatedValueMid  Decimal? @map("estimated_value_mid") @db.Decimal(12, 2)
  valuationReasoning String?  @map("valuation_reasoning") @db.Text
  marketComparisons  Json     @default("[]") @map("market_comparisons") // Similar sales

  // Detailed analysis
  exteriorAnalysis  Json? @map("exterior_analysis")
  interiorAnalysis  Json? @map("interior_analysis")
  mechanicalNotes   Json? @map("mechanical_notes")
  authenticityCheck Json? @map("authenticity_check")

  // Investment perspective
  investmentOutlook     String? @map("investment_outlook") // 'strong', 'moderate', 'speculative'
  appreciationPotential String? @map("appreciation_potential") @db.Text

  // Processing metadata
  modelUsed        String? @map("model_used")
  tokensUsed       Int?    @map("tokens_used")
  processingTimeMs Int?    @map("processing_time_ms")
  errorMessage     String? @map("error_message") @db.Text

  // Visibility
  isPublished Boolean   @default(false) @map("is_published")
  publishedAt DateTime? @map("published_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([listingId])
  @@index([status])
  @@index([isPublished])
  @@map("ai_car_reviews")
}

enum CommentModerationStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

model AICommentModeration {
  id        String  @id @default(cuid())
  commentId String  @map("comment_id")
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Moderation result
  status          CommentModerationStatus @default(PENDING)
  decision        ModerationDecision?
  confidenceScore Float?                  @map("confidence_score")

  // Analysis details
  isSpam          Boolean @default(false) @map("is_spam")
  spamScore       Float?  @map("spam_score")
  isInappropriate Boolean @default(false) @map("is_inappropriate")
  toxicityScore   Float?  @map("toxicity_score")
  isOffTopic      Boolean @default(false) @map("is_off_topic")

  // Detected issues
  flaggedCategories Json    @default("[]") @map("flagged_categories") // spam, harassment, etc.
  reasoning         String? @db.Text

  // Auto-action
  autoActioned Boolean   @default(false) @map("auto_actioned")
  actionTaken  String?   @map("action_taken") // hidden, deleted, approved
  actionedAt   DateTime? @map("actioned_at")

  // Processing metadata
  modelUsed        String? @map("model_used")
  tokensUsed       Int?    @map("tokens_used")
  processingTimeMs Int?    @map("processing_time_ms")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([commentId])
  @@index([status])
  @@index([isSpam])
  @@map("ai_comment_moderation")
}

model AIBidPatternAnalysis {
  id        String  @id @default(cuid())
  auctionId String  @map("auction_id")
  userId    String? @map("user_id")

  // Analysis window
  analysisWindowStart DateTime @map("analysis_window_start")
  analysisWindowEnd   DateTime @map("analysis_window_end")

  // Pattern detection
  isSuspicious   Boolean @default(false) @map("is_suspicious")
  suspicionScore Float?  @map("suspicion_score")
  patternType    String? @map("pattern_type") // shill, bot, coordinated, rapid-fire

  // Detected patterns
  patterns  Json @default("[]") // Array of detected patterns
  anomalies Json @default("[]") // Statistical anomalies

  // Bid velocity metrics
  bidsAnalyzed       Int    @default(0) @map("bids_analyzed")
  avgTimeBetweenBids Float? @map("avg_time_between_bids")
  bidVelocityScore   Float? @map("bid_velocity_score")

  // User behavior
  userPatterns Json? @map("user_patterns") // User-specific patterns
  ipPatterns   Json? @map("ip_patterns") // IP correlation patterns

  // Recommendations
  recommendedAction String? @map("recommended_action") // monitor, warn, block
  reasoning         String? @db.Text

  // Processing metadata
  modelUsed        String? @map("model_used")
  tokensUsed       Int?    @map("tokens_used")
  processingTimeMs Int?    @map("processing_time_ms")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([auctionId])
  @@index([userId])
  @@index([isSuspicious])
  @@index([createdAt(sort: Desc)])
  @@map("ai_bid_pattern_analysis")
}

// ============================================================================
// SYSTEM CONFIGURATION
// ============================================================================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "ai.moderation", "ai.licensePlate"
  value     Json // Configuration values as JSON
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") // Admin user ID who made the change

  // Version history for rollback
  history SystemConfigHistory[]

  @@map("system_config")
}

model SystemConfigHistory {
  id        String   @id @default(cuid())
  configId  String   @map("config_id")
  config    SystemConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  key       String   // Snapshot of key at time of change
  value     Json     // Previous value before change
  changedBy String?  @map("changed_by") // Who made the change
  changedAt DateTime @default(now()) @map("changed_at")

  @@index([configId, changedAt(sort: Desc)])
  @@map("system_config_history")
}

// ============================================================================
// SELLER REVIEWS
// ============================================================================

model SellerReview {
  id         String   @id @default(cuid())
  sellerId   String   @map("seller_id")
  seller     User     @relation("SellerReviews", fields: [sellerId], references: [id], onDelete: Cascade)
  reviewerId String   @map("reviewer_id")
  reviewer   User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  auctionId  String   @map("auction_id")
  auction    Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  rating     Int      // 1-5 stars
  title      String?
  content    String?  @db.Text

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([auctionId, reviewerId]) // One review per auction per buyer
  @@index([sellerId, createdAt(sort: Desc)])
  @@map("seller_reviews")
}

// ============================================================================
// MESSAGING MODELS
// ============================================================================

model Conversation {
  id        String   @id @default(cuid())
  listingId String   @map("listing_id")
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyerId   String   @map("buyer_id")
  buyer     User     @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId  String   @map("seller_id")
  seller    User     @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  messages  Message[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([listingId, buyerId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([updatedAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String       @map("sender_id")
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String       @db.Text
  isRead         Boolean      @default(false) @map("is_read")
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

// ============================================================================
// AI LISTING IMPROVEMENTS (for expired/unsold auctions)
// ============================================================================

model AIListingImprovement {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  auctionId String  @map("auction_id")

  // Why it didn't sell
  reason String // 'no_bids' | 'reserve_not_met'

  // Pricing suggestions
  suggestedStartingPrice Decimal? @map("suggested_starting_price") @db.Decimal(12, 2)
  suggestedReserve       Decimal? @map("suggested_reserve") @db.Decimal(12, 2)
  avgMarketPrice         Decimal? @map("avg_market_price") @db.Decimal(12, 2)
  pricingReasoning       String?  @map("pricing_reasoning") @db.Text

  // Full suggestions as JSON
  suggestions Json @default("{}")

  // Top priorities for quick display
  topPriorities String[] @map("top_priorities")

  // Market data used for analysis
  localSalesCount  Int @default(0) @map("local_sales_count")
  globalSalesCount Int @default(0) @map("global_sales_count")
  marketData       Json @default("{}") @map("market_data")

  // AI metadata
  status           AIAnalysisStatus @default(PENDING)
  modelUsed        String?          @map("model_used")
  tokensUsed       Int?             @map("tokens_used")
  processingTimeMs Int?             @map("processing_time_ms")
  errorMessage     String?          @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([listingId])
  @@index([auctionId])
  @@index([status])
  @@map("ai_listing_improvements")
}

// ============================================================================
// EXTERNAL AUCTION SALES (from BaT, Catawiki, etc.)
// ============================================================================

model ExternalAuctionSale {
  id        String @id @default(cuid())
  source    String // "Bring a Trailer", "Catawiki", "RM Sothebys"
  sourceUrl String @map("source_url") @db.Text

  // Vehicle info
  title String
  make  String
  model String
  year  Int

  // Pricing
  soldPrice Decimal @map("sold_price") @db.Decimal(12, 2)
  currency  String // Original currency (USD, EUR, GBP)
  priceEur  Decimal @map("price_eur") @db.Decimal(12, 2) // Converted to EUR

  // Sale details
  saleDate  DateTime @map("sale_date")
  location  String?
  condition String?
  mileage   Int?
  imageUrl  String?  @map("image_url") @db.Text

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([sourceUrl]) // Don't duplicate same auction
  @@index([make, model])
  @@index([saleDate(sort: Desc)])
  @@index([source])
  @@index([year])
  @@map("external_auction_sales")
}
