generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH.JS MODELS
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// USER MODELS
// ============================================================================

enum Role {
  USER
  SELLER
  MODERATOR
  REVIEWER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  phone         String?
  image         String?
  passwordHash  String?   @map("password_hash")
  role          Role      @default(USER)

  // Bidding eligibility
  biddingEnabled   Boolean @default(false)
  stripeCustomerId String? @map("stripe_customer_id")

  // Stripe Connect (for sellers)
  stripeConnectAccountId   String?   @map("stripe_connect_account_id")
  stripeConnectStatus      String?   @map("stripe_connect_status") // 'pending', 'active', 'restricted'
  payoutEnabled            Boolean   @default(false) @map("payout_enabled")
  stripeConnectOnboardedAt DateTime? @map("stripe_connect_onboarded_at")

  // Ban tracking
  bannedAt    DateTime? @map("banned_at")
  banReason   String?   @map("ban_reason") @db.Text
  unbannedAt  DateTime? @map("unbanned_at")
  unbanReason String?   @map("unban_reason") @db.Text

  // GDPR & Preferences
  marketingConsent     Boolean   @default(false)
  marketingConsentDate DateTime? @map("marketing_consent_date")
  preferredLanguage    String    @default("en") @map("preferred_language")
  preferredCurrency    String    @default("EUR") @map("preferred_currency")
  termsAcceptedAt      DateTime? @map("terms_accepted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts       Account[]
  sessions       Session[]
  listings       Listing[]
  bids           Bid[]
  watchlist      Watchlist[]
  bidDeposits    BidDeposit[]
  comments       Comment[]
  auditLogs      AuditLog[]      @relation("AuditActor")
  fraudAlerts    FraudAlert[]
  dataRequests   DataRequest[]
  consentRecords ConsentRecord[]

  @@map("users")
}

// ============================================================================
// LISTING MODELS
// ============================================================================

enum VehicleCategory {
  CLASSIC_CAR
  RETRO_CAR
  BARN_FIND
  PROJECT_CAR
  MOTORCYCLE
  PARTS
  MEMORABILIA
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  CHANGES_REQUESTED
  APPROVED
  REJECTED
  ACTIVE
  SOLD
  WITHDRAWN
  EXPIRED
}

model Listing {
  id       String @id @default(cuid())
  sellerId String @map("seller_id")
  seller   User   @relation(fields: [sellerId], references: [id])

  // Vehicle Info
  title               String
  description         String          @db.Text
  category            VehicleCategory
  make                String
  model               String
  year                Int
  mileage             Int?
  mileageUnit         String          @default("km") @map("mileage_unit")
  vin                 String?
  registrationCountry String?         @map("registration_country")

  // Condition
  conditionRating Int?    @map("condition_rating")
  conditionNotes  String? @map("condition_notes") @db.Text
  knownIssues     String? @map("known_issues") @db.Text
  isRunning       Boolean @default(true) @map("is_running")

  // Location
  locationCountry String  @default("RO") @map("location_country")
  locationCity    String  @map("location_city")
  locationRegion  String? @map("location_region")

  // Pricing
  startingPrice Decimal  @map("starting_price") @db.Decimal(12, 2)
  reservePrice  Decimal? @map("reserve_price") @db.Decimal(12, 2)
  currency      String   @default("EUR")

  // Status & Review
  status          ListingStatus @default(DRAFT)
  reviewedById    String?       @map("reviewed_by_id")
  reviewedAt      DateTime?     @map("reviewed_at")
  rejectionReason String?       @map("rejection_reason") @db.Text
  changeRequests  Json          @default("[]") @map("change_requests")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  submittedAt DateTime? @map("submitted_at")
  approvedAt  DateTime? @map("approved_at")

  // Relations
  media    ListingMedia[]
  auction  Auction?
  comments Comment[]

  @@index([status])
  @@index([sellerId])
  @@index([category])
  @@index([status, createdAt(sort: Desc)])
  @@map("listings")
}

enum MediaType {
  PHOTO
  VIDEO
}

model ListingMedia {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  type         MediaType
  storagePath  String    @map("storage_path")
  publicUrl    String    @map("public_url")
  thumbnailUrl String?   @map("thumbnail_url")

  position  Int
  isPrimary Boolean @default(false) @map("is_primary")
  category  String? // exterior, interior, engine, documentation, etc.
  caption   String?

  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")
  width    Int?
  height   Int?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([listingId])
  @@map("listing_media")
}

// ============================================================================
// AUCTION MODELS
// ============================================================================

enum AuctionStatus {
  SCHEDULED
  ACTIVE
  EXTENDED
  ENDED
  SOLD
  NO_SALE
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Auction {
  id        String  @id @default(cuid())
  listingId String  @unique @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id])

  // Timing
  startTime       DateTime @map("start_time")
  originalEndTime DateTime @map("original_end_time")
  currentEndTime  DateTime @map("current_end_time")

  // Anti-sniping
  antiSnipingEnabled          Boolean @default(true) @map("anti_sniping_enabled")
  antiSnipingWindowMinutes    Int     @default(2) @map("anti_sniping_window_minutes")
  antiSnipingExtensionMinutes Int     @default(2) @map("anti_sniping_extension_minutes")
  extensionCount              Int     @default(0) @map("extension_count")
  maxExtensions               Int     @default(10) @map("max_extensions")

  // Pricing
  startingPrice Decimal  @map("starting_price") @db.Decimal(12, 2)
  reservePrice  Decimal? @map("reserve_price") @db.Decimal(12, 2)
  reserveMet    Boolean  @default(false) @map("reserve_met")
  currentBid    Decimal? @map("current_bid") @db.Decimal(12, 2)
  bidIncrement  Decimal  @default(100) @map("bid_increment") @db.Decimal(12, 2)
  currency      String   @default("EUR")

  // Bid tracking
  bidCount Int @default(0) @map("bid_count")

  // Status
  status AuctionStatus @default(SCHEDULED)

  // Winner
  winnerId     String?  @map("winner_id")
  winningBidId String?  @map("winning_bid_id")
  finalPrice   Decimal? @map("final_price") @db.Decimal(12, 2)

  // Fees
  buyerFeeRate   Decimal  @default(0.05) @map("buyer_fee_rate") @db.Decimal(4, 3)
  buyerFeeAmount Decimal? @map("buyer_fee_amount") @db.Decimal(12, 2)

  // Payment tracking (buyer)
  paymentStatus   PaymentStatus @default(UNPAID) @map("payment_status")
  paymentIntentId String?       @map("payment_intent_id")
  paidAt          DateTime?     @map("paid_at")
  paymentDeadline DateTime?     @map("payment_deadline")

  // Seller payout tracking
  sellerPayoutStatus String?   @map("seller_payout_status") // 'pending', 'processing', 'completed', 'failed'
  sellerPayoutId     String?   @map("seller_payout_id") // Stripe transfer ID
  sellerPayoutAmount Decimal?  @map("seller_payout_amount") @db.Decimal(12, 2)
  sellerPaidAt       DateTime? @map("seller_paid_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bids      Bid[]
  watchlist Watchlist[]

  @@index([status])
  @@index([currentEndTime])
  @@map("auctions")
}

model Bid {
  id        String  @id @default(cuid())
  auctionId String  @map("auction_id")
  auction   Auction @relation(fields: [auctionId], references: [id])
  bidderId  String  @map("bidder_id")
  bidder    User    @relation(fields: [bidderId], references: [id])

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  isWinning         Boolean @default(false) @map("is_winning")
  isValid           Boolean @default(true) @map("is_valid")
  invalidatedReason String? @map("invalidated_reason")

  triggeredExtension Boolean @default(false) @map("triggered_extension")

  depositHoldId String? @map("deposit_hold_id")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([auctionId])
  @@index([bidderId])
  @@index([createdAt(sort: Desc)])
  @@index([auctionId, isValid, createdAt(sort: Desc)])
  @@map("bids")
}

// ============================================================================
// PAYMENT MODELS
// ============================================================================

enum DepositStatus {
  PENDING
  HELD
  CAPTURED
  RELEASED
  FAILED
}

model BidDeposit {
  id        String  @id @default(cuid())
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id])
  auctionId String? @map("auction_id")

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  stripePaymentIntentId String  @map("stripe_payment_intent_id")
  stripePaymentMethodId String? @map("stripe_payment_method_id")

  status DepositStatus @default(PENDING)

  heldAt     DateTime? @map("held_at")
  releasedAt DateTime? @map("released_at")
  capturedAt DateTime? @map("captured_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([auctionId])
  @@index([status])
  @@index([userId, status, createdAt])
  @@map("bid_deposits")
}

// ============================================================================
// ENGAGEMENT MODELS
// ============================================================================

model Watchlist {
  id        String  @id @default(cuid())
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId String  @map("auction_id")
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  notifyOnBid Boolean @default(true) @map("notify_on_bid")
  notifyOnEnd Boolean @default(true) @map("notify_on_end")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, auctionId])
  @@index([userId])
  @@index([auctionId])
  @@index([auctionId, notifyOnBid])
  @@index([auctionId, notifyOnEnd])
  @@index([userId, createdAt(sort: Desc)])
  @@map("watchlist")
}

model Comment {
  id        String  @id @default(cuid())
  listingId String  @map("listing_id")
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  authorId  String  @map("author_id")
  author    User    @relation(fields: [authorId], references: [id])
  parentId  String? @map("parent_id")

  content  String  @db.Text
  isHidden Boolean @default(false) @map("is_hidden")
  isPinned Boolean @default(false) @map("is_pinned")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([listingId])
  @@index([authorId])
  @@map("comments")
}

// ============================================================================
// FRAUD & AUDIT MODELS
// ============================================================================

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  FALSE_POSITIVE
}

model FraudAlert {
  id        String  @id @default(cuid())
  userId    String? @map("user_id")
  user      User?   @relation(fields: [userId], references: [id])
  auctionId String? @map("auction_id")
  bidId     String? @map("bid_id")

  alertType String        @map("alert_type")
  severity  AlertSeverity
  details   Json

  status          AlertStatus @default(OPEN)
  reviewedById    String?     @map("reviewed_by_id")
  reviewedAt      DateTime?   @map("reviewed_at")
  resolutionNotes String?     @map("resolution_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([severity])
  @@map("fraud_alerts")
}

enum AuditSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AuditStatus {
  SUCCESS
  FAILURE
  BLOCKED
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  actorId        String? @map("actor_id")
  actor          User?   @relation("AuditActor", fields: [actorId], references: [id])
  actorEmail     String? @map("actor_email")
  actorIp        String? @map("actor_ip")
  actorUserAgent String? @map("actor_user_agent") @db.Text

  action       String
  resourceType String  @map("resource_type")
  resourceId   String? @map("resource_id")

  severity AuditSeverity?
  status   AuditStatus?

  details      Json    @default("{}")
  changes      Json?
  errorMessage String? @map("error_message") @db.Text

  sessionId    String? @map("session_id")
  requestId    String? @map("request_id")
  functionName String? @map("function_name")

  @@index([createdAt(sort: Desc)])
  @@index([actorId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([severity])
  @@index([action, createdAt(sort: Desc)])
  @@map("audit_log")
}

// ============================================================================
// GDPR MODELS
// ============================================================================

enum ConsentType {
  ESSENTIAL
  ANALYTICS
  MARKETING
  DATA_PROCESSING
}

model ConsentRecord {
  id     String  @id @default(cuid())
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  consentType ConsentType @map("consent_type")
  granted     Boolean

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([ipAddress])
  @@map("consent_records")
}

enum DataRequestType {
  EXPORT
  DELETE
  RECTIFY
}

enum DataRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

model DataRequest {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  requestType DataRequestType   @map("request_type")
  status      DataRequestStatus @default(PENDING)

  exportFilePath  String?   @map("export_file_path")
  exportExpiresAt DateTime? @map("export_expires_at")

  processedById   String?   @map("processed_by_id")
  processedAt     DateTime? @map("processed_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@map("data_requests")
}
